name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Lint and Type Check
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint
      run: npm run lint
      continue-on-error: false

  # Job 2: Build Test
  build:
    name: Build Test
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build production bundle
      run: npm run build
      
    - name: Check build output
      run: |
        if [ ! -d "dist" ]; then
          echo "Error: dist directory not created"
          exit 1
        fi
        if [ ! -f "dist/index.html" ]; then
          echo "Error: index.html not found in dist"
          exit 1
        fi
        echo "✅ Build successful"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: production-files
        path: dist/
        retention-days: 7

  # Job 3: Dependency Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

  # Job 4: Check File Structure
  structure:
    name: Validate File Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check required files exist
      run: |
        echo "Checking required files..."
        
        # Root files
        test -f "package.json" || { echo "❌ package.json missing"; exit 1; }
        test -f "vite.config.js" || { echo "❌ vite.config.js missing"; exit 1; }
        test -f "tailwind.config.js" || { echo "❌ tailwind.config.js missing"; exit 1; }
        test -f "index.html" || { echo "❌ index.html missing"; exit 1; }
        
        # Source files
        test -f "src/main.jsx" || { echo "❌ src/main.jsx missing"; exit 1; }
        test -f "src/App.jsx" || { echo "❌ src/App.jsx missing"; exit 1; }
        test -f "src/App.css" || { echo "❌ src/App.css missing"; exit 1; }
        test -f "src/index.css" || { echo "❌ src/index.css missing"; exit 1; }
        
        # Components
        test -d "src/components" || { echo "❌ src/components directory missing"; exit 1; }
        test -f "src/components/Hero.jsx" || { echo "❌ Hero.jsx missing"; exit 1; }
        test -f "src/components/Navigation.jsx" || { echo "❌ Navigation.jsx missing"; exit 1; }
        
        echo "✅ All required files present"

  # Job 5: Status Check Summary
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, build, security, structure]
    if: always()
    
    steps:
    - name: Check CI Status
      run: |
        if [ "${{ needs.lint.result }}" != "success" ]; then
          echo "❌ Lint failed"
          exit 1
        fi
        if [ "${{ needs.build.result }}" != "success" ]; then
          echo "❌ Build failed"
          exit 1
        fi
        if [ "${{ needs.structure.result }}" != "success" ]; then
          echo "❌ File structure validation failed"
          exit 1
        fi
        echo "✅ All CI checks passed!"
